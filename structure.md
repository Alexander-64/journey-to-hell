# Введение

Всем привет, меня зовут Александр Петрушин, я frontend teamlead в компании Инфосистемы Джет
В конце марта 20-го я устроился в Jet на проект "Офсайт Росреестра". Опыт оказался для меня полезным, о чем я и хочу рассказать.

## Предмет разработки

[Личный кабинет правообладателя](lk.rosreestr.ru) - это набор сервисов который покрывает все операции в отношении объектов недвижимости: запрос сведений, регистрация, уточнение сведений, получение выписки из ЕГРН и множество других операций.

Что нам было нужно сделать:

- осуществить редизайн
- улучшить время загрузки сайта (до 2 секунд при скорости 1Мб\сек)
- доработать все формы подачи услуг (80+ услуг)
- реализовать ряд новых услуг, в том числе совместную подачу заявлений несколькими пользователями

## Предыстория

До меня уже было 4 человека фронтенд разработчика со своим лидом, они занимались предыдущими 4 этапами, не Личным кабинетом РР. Личный кабинет представлялся на этапе заключения контракта большой работой и меня брали в качестве усиления команды. Так как брали меня на конкретный проект, то доступы к исходной кодовой базе я получил практически сразу. Качаю проект из гитлаба. Начало апреля, яркое солнце, начало пандемии. Скачался, открываю. А там...

# Начало

> "На него невозможно было смотреть без содрогания. Никакая мумия, возвращенная к жизни, не могла быть ужаснее этого чудовища. Я видел своё творение неоконченным; оно и тогда было уродливо; но когда его суставы и мускулы пришли в движение, получилось нечто более страшное, чем все вымыслы Данте."  
> _Мэри Шелли «Франкенштейн, или Современный Прометей»_

## Обследование доставшейся кодовой базы

Укрупненно, фронт состоял из двух частей:

1. Корневое приложение реализующее авторизацию и клиентской роутинг. В нем же написаны сервисы (например, [Справочная информация по объектам недвижимости в режиме online](https://lk.rosreestr.ru/eservices/real-estate-objects-online)). Стек:

- Js, coffescript
- Angular 1.4
- Gulp
- bower и npm, сразу оба, чего бы и да.
- тесты на karma + protractor

Ладно, думаю. Давайте дальше.

2. самописный фреймворк на котором были реализованы услуги (которых 80+). Внедрялся в корневое приложение.

- чистый ES5
- под капотом backbone (0.9.10)
- сборщика нет, все файлы исходного кода реализуют паттерн модуль и подключается через тег `<script/>`. Как следствие, сталкиваемся с ограничениями по количеству открытых соединений
- кодовой базе на тот момент было лет ~10, судя по комментариям в коде и примененных технологий
- тестов нет

Стоит упомянуть как этот фреймворк работал.

1. Для создания/редактирования услуги открывается редактор (отдельный UI как часть работы со смартформами)
2. подгружается json конкретной услуги, движок его парсит и отрисовывает соответсвующую услугу. в Json содержится информация какими контролами представлены поля вью-модели, в каких панелях и прочее
3. Несмотря на то что валидация формы и ее последующая отправка реализована внутри движка, есть возможность вешать кастомные обработчики. В качестве примера, в обход от общего механизма внезапно сделать запрос и получить необходимый справочник.
4. Итоговую услугу после создания или редактирования сохраняем в базу данных.
5. В клиентском приложении делается запрос к серверу, который достает из базы вьюмодель и отдает на фронт.
6. На клиенте модель парсится и движок ее отрисовывает

Итого, какие проблемы мы имеем:

- отсутствующую документацию на уровне кода. Никаких схем, никаких тестов
- При целевой скорости загрузки 1 Mbit/s с чистым кешем сайт грузился порядка 30 секунд, против необходимых 2. Во многом причина была в том, сайт делал 196 запросов чтобы отрисоваться (при обновлении вкладки на услуге), исходный код не был минифицирован. Однако, сделав попытку собрать код в один бандл я обнаружил что местами была важен порядок подключения скриптов (!). За разумное время задача решена не была, и сложно сказать сколько бы это заняло.
- кодовая база развивалась различными подрядчиками на протяжении примерно 10 лет. Вследствии этого, попытки привнести ту или иную технологию (с последующими надеждами переписать остальное, видимо) доведены до конца не были. Как итог, имеется "зоопарк" технологий.
- безнадежно устаревшие технологии Как следствие:
  - неизбежно вызовут лаг по овладению компетенциями командой
  - мотивировать разработчиков на работу с такими старыми технологиями проблематично. Представьте: "Пс, парень! Да-да, ты. Хочешь изучить технологию которая тебе в жини больше не пригодится никогда? я так и думал, держи синюю таблетку".
  - В текущих реалиях рынка найти человека со знаниями технологий чтобы начал приносить пользу сразу, и чтобы его стоимость была ниже уровня senior+ представляется трудноосуществимым и занять может продолжительное время.
- Невозожность оценить количество ресурсов, необходимых на реализацию заявленного функционала

Напомню, доставшаяся мне команда состояла из 2 джунов, 1 мидла, 1 сеньора, которые в принципе владеют только React'ом и библиотеками из его экосистемы.

## Попытки развития имеющейся кодовой базы

> "Бойня и анатомический театр поставляли мне большую часть моих материалов; и я часто содрогался от отвращения, но, подгоняемый всё возрастающим нетерпением, всё же вёл работу к концу."  
> _Мэри Шелли «Франкенштейн, или Современный Прометей»_

К июню команда заканчивала активности по предыдущим этапам, и остро встал вопрос о том, что делать дальше. Начали с простого - редизайна, попутно ожидая формализации требований от аналитиков.
С редизайном было достаточно просто - ангуляровское приложение и приложение фреймворка услуг использовало компоненты, тем более в нашей команде был свой дизайнер, с которым мы решали вопросы достаточно оперативно.

В случае с разработкой новых сервисов и доработкой существующих было сложнее. Ввиду описанных выше сложностей, мы решили переписать на реакт те сервисы и услуги, которые затрагивались для доработок, и реализовать новый функционал на нем же. Внедрить получилось, однако сама идея порождала ряд интересных моментов:

- необходимо было управлять загрузкой библитеки React, асинхронно грузить при переходе на главную, либо при обвнолении вкладки страницы реализованной на реакте грузить. В общем, тут явно требовался механизм чтобы управлять всеми такими кейсами
- связанный с предыдущим пунктом широкий вопрос доставки клиентского кода:
  - необходимо было прикрутить бандлер к доставшемуся самописному фреймворку работы с услугами чтобы решить проблему ограничения параллельных запросов, минифицировать его
  - разбить на чанки исходный код ангуляровского приложения (собирался на gulp)
  - выстроить процесс сборки всего этого для поставки на CI
- получилось бы нам попасть в заявленные 2 секунды при 1 Mbit/s? Не уверен. Нужно бы было очень хорошо разобраться в устройсвтве фреймворка, засплитить все что только можно. С ангуляром было бы проще, но следует понимать, что мы бы все равно грузили большое количество кода (как минимум сразу Angular + Backbone + код самого фреймворка) для отображения только одной услуги при явном переходе к ней по url

В общем, если бы Виктор Франкенштейн увидел этот итоговый результат он бы понял, что его работа это всего лищь возня в детской песочнице. К счастью, в июле месяце после встречи с заказчиком стало ясно, что услуги будут переработаны практически полностью, от редизайна ждут сильно больше чем просто "перекрасить" контролы.

# Что сделали:

- оставшийся практически без изменений контракт с бэкенд разработкой
- структура проекта (lerna, выделенная библиотека компонентов)
- деление на "странциы" и фреймворк работы с виджетами
- code-splitting
- тестовое покрытие
- Преимущества решения (актуальный стек, отдельные модули)
- Недостатки решения

Процесс разработки в команде фронта

- дейли, код ревью
- онбординг новых разработчиков, как мы это сделали "мгновенно"
- неформальзованное дизайн-ревью, почему зашло
- тесты (сайпресс, тесты по требованиям, CI\CD на каждый МР)
- разделение команды на стримы (2 команды штата, 1 подрядчики)

Личные уроки

- Как справиться с взрывообразным ростом команды
- сложности организации процесса разработки с другими командами
- проектные сложности

- _Авторы _ \*
  Екатерина Перепелица
