# Введение

Всем привет, меня зовут Александр Петрушин, я frontend teamlead в компании Инфосистемы Джет
В конце марта 20-го я устроился в Jet на проект "Офсайт Росреестра". Опыт оказался для меня полезным, о чем я и хочу рассказать.

## Предмет разработки

[Личный кабинет правообладателя](lk.rosreestr.ru) - это набор сервисов который покрывает все операции в отношении объектов недвижимости: запрос сведений, регистрация, уточнение сведений, получение выписки из ЕГРН и множество других операций.

Что нам было нужно сделать:

- осуществить редизайн
- улучшить время загрузки сайта (до 2 секунд при скорости 1Мб\сек)
- доработать все формы подачи услуг (80+ услуг)
- реализовать ряд новых услуг, в том числе совместную подачу заявлений несколькими пользователями

## Предыстория

До меня уже было 4 человека фронтенд разработчика со своим лидом, они занимались предыдущими 4 этапами, не Личным кабинетом РР. Личный кабинет представлялся на этапе заключения контракта большой работой и меня брали в качестве усиления команды. Так как брали меня на конкретный проект, то доступы к исходной кодовой базе я получил практически сразу. Качаю проект из гитлаба. Начало апреля, яркое солнце, начало пандемии. Скачался, открываю. А там...

# Начало

## Обследование доставшейся кодовой базы

Укрупненно, фронт состоял из двух частей:

1. Корневое приложение реализующее авторизацию и клиентской роутинг. В нем же написаны сервисы (например, [Справочная информация по объектам недвижимости в режиме online](https://lk.rosreestr.ru/eservices/real-estate-objects-online)). Стек:

- Js, coffescript
- Angular 1.4
- Gulp
- bower и npm, сразу оба, чего бы и да.
- тесты на karma + protractor

Ладно, думаю. Давайте дальше.

2. самописный фреймворк на котором были реализованы услуги (которых 80+). Внедрялся в корневое приложение.

- чистый ES5
- под капотом backbone (0.9.10)
- сборщика нет, все файлы исходного кода реализуют паттерн модуль и подключается через тег `<script/>`. Как следствие, сталкиваемся с ограничениями по количеству открытых соединений
- кодовой базе на тот момент было лет ~10, судя по комментариям в коде и примененных технологий
- тестов нет

Стоит упомянуть как этот фреймворк работал.

1. Для создания/редактирования услуги открывается редактор (отдельный UI как часть работы со смартформами)
2. подгружается json конкретной услуги, движок его парсит и отрисовывает соответсвующую услугу. в Json содержится информация какими контролами представлены поля вью-модели, в каких панелях и прочее
3. Несмотря на то что валидация формы и ее последующая отправка реализована внутри движка, есть возможность вешать кастомные обработчики. В качестве примера, в обход от общего механизма внезапно сделать запрос и получить необходимый справочник.
4. Итоговую услугу после создания или редактирования сохраняем в базу данных.
5. В клиентском приложении делается запрос к серверу, который достает из базы вьюмодель и отдает на фронт.
6. На клиенте модель парсится и движок ее отрисовывает

Итого, какие проблемы мы имеем:

- отсутствующую документацию на уровне кода. Никаких схем, никаких тестов
- При целевой скорости загрузки 1 Mbit/s с чистым кешем сайт грузился порядка 30 секунд, против необходимых 2. Во многом причина была в том, сайт делал 196 запросов чтобы отрисоваться (при обновлении вкладки на услуге), исходный код не был минифицирован. Однако, сделав попытку собрать код в один бандл я обнаружил что местами была важен порядок подключения скриптов (!). За разумное время задача решена не была, и сложно сказать сколько бы это заняло.
- кодовая база развивалась различными подрядчиками на протяжении примерно 10 лет. Вследствии этого, попытки привнести ту или иную технологию (с последующими надеждами переписать остальное, видимо) доведены до конца не были. Как итог, имеется "зоопарк" технологий.
- безнадежно устаревшие технологии Как следствие:
  - неизбежно вызовут лаг по овладению компетенциями командой
  - мотивировать разработчиков на работу с такими старыми технологиями проблематично. Представьте: "Пс, парень! Да-да, ты. Хочешь изучить технологию которая тебе в жини больше не пригодится никогда?"
  - В текущих реалиях рынка найти человека со знаниями технологий чтобы начал приносить пользу сразу, и чтобы его стоимость была ниже уровня senior+ представляется трудноосуществимым и занять может продолжительное время.
- Невозожность оценить количество ресурсов, необходимых на реализацию заявленного функционала

Напомню, доставшаяся мне команда состояла из 2 джунов, 1 мидла, 1 сеньора, которые в принципе владеют только React'ом и библиотеками из его экосистемы.

# Попытки развития имеющейся кодовой базы

К маю-июню команда заканчивала активности по предыдущим этапам,

# Что делать?

# Что сделали:

- оставшийся практически без изменений контракт с бэкенд разработкой
- структура проекта (lerna, выделенная библиотека компонентов)
- деление на "странциы" и фреймворк работы с виджетами
- code-splitting
- тестовое покрытие
- Преимущества решения (актуальный стек, отдельные модули)
- Недостатки решения

Процесс разработки в команде фронта

- дейли, код ревью
- онбординг новых разработчиков, как мы это сделали "мгновенно"
- неформальзованное дизайн-ревью, почему зашло
- тесты (сайпресс, тесты по требованиям, CI\CD на каждый МР)
- разделение команды на стримы (2 команды штата, 1 подрядчики)

Личные уроки

- Как справиться с взрывообразным ростом команды
- сложности организации процесса разработки с другими командами
- проектные сложности

- _Авторы _ \*
  Екатерина Перепелица
